<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script defer src="/pub/alpine.min.js"></script>

    <title>Document</title>
    {{template "common-css"}}
    <style>
        :root {
            direction: ltr;
        }

        body {
            padding: 1rem;
            font-family: 'inter';
            width: 100vw;
        }

        td {
            padding: .5rem 1rem;
            white-space: nowrap;
        }

        table {
            text-align: center;
            overflow: scroll;
        }

        table thead,
        tr:nth-child(even) {
            background-color:
                color-mix(in srgb, var(--accent, blue), transparent 90%);
        }

        #ed {

            >div {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                min-width: 500px;

                div {
                    display: flex;
                    align-items: center;
                    flex-direction: row;
                    gap: 1rem;
                }
            }
        }
    </style>
</head>

<body x-data="{ modalInfo: { } }">
    <div style="margin: 1rem;">
        <div>Style isnt an issue</div>
        <a style="display: block;" href="/rd/rev/">اذهب إلى قائمة المراجعة</a>
    </div>
    <div>
        <table>
            <thead>
                <td>Word</td>
                <td>Due at</td>
                <td>Seen at</td>
                <td>Viablitily</td>
                <td>Edit</td>
            </thead>
            {{range .}}
            <tr x-data="{
                word: '{{.Word}}',
                dontShow: {{.DontShow}},
                future: '{{.Future | fmtUnix}}',
                past: '{{.Past | fmtUnix}}',
            }">
                <td>{{.Word}}</td>
                <td class="time-stamp" x-text="future"></td>
                <td class="time-stamp" x-text="past"></td>
                <td x-text="dontShow ? 'Hidden' : 'Shown'"></td>
                <td>
                    <button @click="modalInfo = $data; $refs.modal.showModal()">
                        Edit
                    </button>
                </td>
            </tr>
            {{end}}
        </table>
    </div>
    <dialog id="ed" x-ref="modal">
        <div>
            <div x-text="modalInfo.word"></div>
            <div>
                <label for="hideTgl">Viablitily touggle:</label>
                <button id="hideTgl" x-text="modalInfo.dontShow ? 'Show' : 'Hide'" @click="
                            updating = true; // disable immediately
                            modalInfo.dontShow = !modalInfo.dontShow;

                            fetch(`${window.location.pathname}?w=${encodeURIComponent(modalInfo.word)}&dontshow=${modalInfo.dontShow ? 'false' : 'true'}`, {
                                method: 'POST'
                            })
                            .then(res => {
                                if (res.status === 202) {
                                    // server accepted, update button text
                                    modalInfo.dontShow = modalInfo.dontShow; // already toggled locally
                                } else {
                                    // revert toggle if server rejected
                                    modalInfo.dontShow = !modalInfo.dontShow;
                                    console.error('Server did not accept the change');
                                }
                            })
                            .catch(err => {
                                // revert toggle if error
                                modalInfo.dontShow = !modalInfo.dontShow;
                                console.error(err);
                            })
                            .finally(() => updating = false); // re-enable
                    "></button>
            </div>
            <div>
                <div>Will be shown: <span x-text="modalInfo.future"></span></div>
                <button id="reset" @click="modalInfo.future = '...'">Reset</button>
            </div>

            <form method="dialog">
                <button>Close</button>
            </form>
        </div>
    </dialog>

    <script>
        // const ed = document.getElementById("ed");
        // const word = document.getElementById("word");
        // const hideTgl = document.getElementById("hideTgl");
        // const wbs = document.getElementById("willBeShown");
        // const wReset = document.getElementById("reset");

        // function edOpen(_word, donthowShowStr, willBeShown, past, future) {
        //     word.innerText = _word;
        //     let noshow = donthowShowStr == "true";
        //     hideTgl.innerText = noshow ? "Show" : "Hide";

        //     wReset.onclick = () => {
        //         postThen(`${window.location.pathname}?w=${_word}&after=reset`,
        //             () => {
        //                 noshow = !noshow;
        //                 alert(`The word "${_word}": reseted. reaload to see`)
        //             });
        //     }

        //     hideTgl.onclick = () => {
        //         postThen(`${window.location.pathname}?w=${_word}&dontshow=${noshow ? "false" : "true"}`,
        //             () => {
        //                 noshow = !noshow;
        //                 alert(`The word "${_word}": ${noshow ? "will be shown" : "is hidden"}. reaload to see`)
        //                 // document.querySelector(`[data-isHidden="${_word}"]`).innerText = noshow ? "Shown" : "Hidden"
        //                 hideTgl.innerText = noshow ? "Show" : "Hide";
        //             });
        //     }

        //     wbs.innerText = willBeShown;

        //     ed.showModal();
        // }

        function post(perm) {
            return fetch(`${window.location.href}?${perm}`, { method: "POST" })
        }

    </script>
</body>

</html>