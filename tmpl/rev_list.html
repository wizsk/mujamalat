<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Review Table</title>
    <link rel="stylesheet" href="/pub/styles/rev_list.css">
    <script defer src="/pub/alpine.min.js"></script>
</head>

<body x-data="wordTable()">
    <div class="header-section">
        <a class="nav-link" href="/rd/rev/">اذهب إلى قائمة المراجعة</a>
    </div>

    <div class="table-container">
        <div class="table-scroll">
            <table class="word-table" style="text-align: center;">
                <thead class="table-header">
                    <tr>
                        <th>Word</th>
                        <th>Due at</th>
                        <th>Seen at</th>
                        <th>Visibility</th>
                        <th>Edit</th>
                    </tr>
                </thead>
                <tbody class="table-body">
                    <template x-for="row in words" :key="row.word">
                        <tr>
                            <td class="table-cell cell-word" x-text="row.word"></td>
                            <td class="table-cell cell-date" x-text="row.future ? row.future : '...'"></td>
                            <td class="table-cell cell-date" x-text="row.past ? row.past : '...'"></td>
                            <td class="table-cell cell-status" x-text="row.dontShow ? 'Hidden' : 'Shown'"></td>
                            <td class="table-cell cell-action">
                                <button class="btn btn-primary" @click="openModal(row)">Edit</button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <dialog class="modal" x-ref="modal" @click="if($event.target === $el) closeModal()">
        <div class="modal-content" x-show="selectedWord">
            <h3 class="modal-title" x-text="selectedWord?.word"></h3>

            <div class="modal-section">
                <label class="modal-label">Visibility toggle:</label>
                <button class="btn btn-danger" :disabled="visibilityLoading" @click="toggleVisibility()"
                    x-text="visibilityLoading ? 'Updating…' : (selectedWord?.dontShow ? 'Show' : 'Hide')">
                </button>
            </div>

            <div class="modal-section">
                <div class="modal-label">Will be shown: <span class="modal-value"
                        x-text="selectedWord?.future || 'Not set'"></span></div>
                <button class="btn btn-primary" :disabled="futureLoading" @click="resetFuture()"
                    x-text="futureLoading ? 'Resetting…' : 'Reset'">
                </button>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" @click="closeModal()">Close</button>
            </div>
        </div>
    </dialog>

    <script>
        function wordTable() {
            return {
                words: [
                    // {{range $index, $element := .}}
                    {
                        word: '{{.Word}}',
                        future: '{{.Future | fmtUnix}}',
                        past: '{{.Past | fmtUnix}}',
                        dontShow: '{{.DontShow}}' == 'true',
                    },
                    // {{end}}
                ],
                selectedWord: null,
                visibilityLoading: false,
                futureLoading: false,

                openModal(row) {
                    this.selectedWord = row;
                    this.$refs.modal.showModal();
                },

                closeModal() {
                    this.$refs.modal.close();
                    this.selectedWord = null;
                },

                async toggleVisibility() {
                    if (this.visibilityLoading || !this.selectedWord) return;

                    this.visibilityLoading = true;
                    const original = this.selectedWord.dontShow;
                    this.selectedWord.dontShow = !original;

                    const url = `${window.location.href}?w=${encodeURIComponent(this.selectedWord.word)}&dontshow=${this.selectedWord.dontShow}`;

                    try {
                        const res = await fetch(url, { method: 'POST' });
                        if (res.status !== 202) {
                            this.selectedWord.dontShow = original;
                        }
                    } catch (error) {
                        console.error('Toggle failed:', error);
                        this.selectedWord.dontShow = original;
                    } finally {
                        this.visibilityLoading = false;
                    }
                },

                async resetFuture() {
                    if (this.futureLoading || !this.selectedWord) return;

                    this.futureLoading = true;
                    const original = this.selectedWord.future;
                    this.selectedWord.future = '';

                    const url = `${window.location.href}?w=${encodeURIComponent(this.selectedWord.word)}&after=reset`;

                    try {
                        const res = await fetch(url, { method: 'POST' });
                        if (res.status !== 202) {
                            this.selectedWord.future = original;
                        }
                    } catch (error) {
                        console.error('Reset failed:', error);
                        this.selectedWord.future = original;
                    } finally {
                        this.futureLoading = false;
                    }
                }
            }
        }
    </script>
</body>

</html>